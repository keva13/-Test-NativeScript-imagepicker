"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var application = require("tns-core-modules/application");
var imageSourceModule = require("tns-core-modules/image-source");
var fileSystemModule = require("tns-core-modules/file-system");
var utils_1 = require("tns-core-modules/utils/utils");
var RESULT_CODE_PICKER_IMAGES = 9192;
var context = utils_1.ad.getApplicationContext();
var documents = fileSystemModule.knownFolders.documents();
var folder = documents.getFolder(fileSystemModule.knownFolders.temp().path);
var file = folder.getFile('test.jpg');
var ChooserService = /** @class */ (function () {
    function ChooserService() {
        this.width = 500;
        this.height = 500;
    }
    ChooserService.prototype.getChooserItems = function (intentList) {
        var gallery = new android.content.Intent(android.content.Intent.ACTION_PICK);
        gallery.setType("image/*");
        gallery.putExtra("return-data", true);
        var camera = new android.content.Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);
        camera.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, android.net.Uri.fromFile(new java.io.File(android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg")));
        camera.putExtra("return-data", true);
        intentList = this.addIntentsToList(context, intentList, gallery);
        intentList = this.addIntentsToList(context, intentList, camera);
    };
    ChooserService.prototype.addIntentsToList = function (context, list, intent) {
        var resInfo = context.getPackageManager().queryIntentActivities(intent, 0);
        var size = resInfo.size();
        for (var i = 0; i < size; i++) {
            var packageName = resInfo.get(i).activityInfo.packageName;
            var targetedIntent = new android.content.Intent(intent);
            targetedIntent.packageName = packageName;
            targetedIntent.icon = context.getPackageManager().getApplicationIcon(packageName).getBitmap();
            targetedIntent.label = context.getPackageManager().getApplicationLabel(context.getPackageManager().getApplicationInfo(packageName, 0));
            targetedIntent.setPackage(packageName);
            list.push(targetedIntent);
        }
        return list;
    };
    ChooserService.prototype.getImageFromIntent = function (intent, width, height) {
        var _this = this;
        if (width === void 0) { width = 500; }
        if (height === void 0) { height = 500; }
        this.width = width;
        this.height = height;
        this.currentIntent = intent.packageName;
        return new Promise(function (resolve, reject) {
            application.android.on(application.AndroidApplication.activityResultEvent, function (args) {
                _this.onResult(args).then(function (data) {
                    resolve(data);
                });
            });
            application.android.foregroundActivity.startActivityForResult(intent, RESULT_CODE_PICKER_IMAGES);
        });
    };
    ChooserService.prototype.onResult = function (args) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var requestCode = args.requestCode;
            var resultCode = args.resultCode;
            var data = args.intent;
            if (requestCode === RESULT_CODE_PICKER_IMAGES) {
                if (resultCode === android.app.Activity.RESULT_OK) {
                    var path = android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg";
                    if (_this.currentIntent.length && _this.currentIntent.indexOf('camera') === -1) {
                        imageSourceModule.fromFile(_this._calculateFileUri(data.getData())).saveToFile(path, "jpg", 100);
                    }
                    if (_this.currentIntent.length) {
                        _this.currentIntent = '';
                        _this.takePicture(path);
                        return;
                    }
                    var uri = data.getExtras().getParcelable("data");
                    // let selectedAsset = new imageAssetModule.ImageAsset(this._calculateFileUri(uri));
                    // application.android.off(application.AndroidApplication.activityResultEvent, this.onResult);
                    resolve(imageSourceModule.fromNativeSource(uri).toBase64String("jpg"));
                    // console.log(imageSourceModule.fromFile(this._calculateFileUri(uri)).toBase64String("jpg"));
                    application.android.off(application.AndroidApplication.activityResultEvent);
                }
            }
        });
    };
    ChooserService.prototype.takePicture = function (uri) {
        console.log(imageSourceModule.fromFile(new java.io.File(uri)));
        var takePictureIntent = new android.content.Intent("com.android.camera.action.CROP");
        takePictureIntent.setDataAndType(android.net.Uri.fromFile(new java.io.File(uri)), "image/*");
        takePictureIntent.putExtra("crop", "true");
        takePictureIntent.putExtra("aspectX", 1);
        takePictureIntent.putExtra("aspectY", 1);
        takePictureIntent.putExtra("outputX", this.width);
        takePictureIntent.putExtra("outputY", this.height);
        takePictureIntent.putExtra("return-data", true);
        application.android.foregroundActivity.startActivityForResult(this.addIntentsToList(context, [], takePictureIntent)[0], RESULT_CODE_PICKER_IMAGES);
    };
    ChooserService.prototype._calculateFileUri = function (uri) {
        var DocumentsContract = android.provider.DocumentsContract;
        var isKitKat = android.os.Build.VERSION.SDK_INT >= 19;
        if (isKitKat && DocumentsContract.isDocumentUri(application.android.context, uri)) {
            var docId = void 0, id = void 0, type = void 0;
            var contentUri = null;
            if (this.isExternalStorageDocument(uri)) {
                docId = DocumentsContract.getDocumentId(uri);
                id = docId.split(":")[1];
                type = docId.split(":")[0];
                if ("primary" === type.toLowerCase()) {
                    return android.os.Environment.getExternalStorageDirectory() + "/" + id;
                }
                // TODO handle non-primary volumes
            }
        }
        else {
            // MediaStore (and general)
            if ("content" === uri.getScheme()) {
                return this.getDataColumn(uri, null, null);
            }
            else if ("file" === uri.getScheme()) {
                return uri.getPath();
            }
        }
        return undefined;
    };
    ChooserService.prototype.getDataColumn = function (uri, selection, selectionArgs) {
        var cursor = null;
        var columns = [android.provider.MediaStore.MediaColumns.DATA];
        var filePath;
        try {
            cursor = this.getContentResolver().query(uri, columns, selection, selectionArgs, null);
            if (cursor != null && cursor.moveToFirst()) {
                var column_index = cursor.getColumnIndexOrThrow(columns[0]);
                filePath = cursor.getString(column_index);
                if (filePath) {
                    return filePath;
                }
            }
        }
        catch (e) {
            console.log(e);
        }
        finally {
            if (cursor) {
                cursor.close();
            }
        }
        return undefined;
    };
    ChooserService.prototype.isExternalStorageDocument = function (uri) {
        return "com.android.externalstorage.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isDownloadsDocument = function (uri) {
        return "com.android.providers.downloads.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isMediaDocument = function (uri) {
        return "com.android.providers.media.documents" === uri.getAuthority();
    };
    ChooserService.prototype.getContentResolver = function () {
        return application.android.nativeApp.getContentResolver();
    };
    ChooserService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], ChooserService);
    return ChooserService;
}());
exports.ChooserService = ChooserService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvb3Nlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hvb3Nlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDBEQUE0RDtBQUM1RCxpRUFBbUU7QUFDbkUsK0RBQWlFO0FBQ2pFLHNEQUFnRDtBQUdoRCxJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQztBQUN2QyxJQUFNLE9BQU8sR0FBRyxVQUFFLENBQUMscUJBQXFCLEVBQUUsQ0FBQztBQUMzQyxJQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDNUQsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUUsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUd4QztJQUtJO1FBSEEsVUFBSyxHQUFHLEdBQUcsQ0FBQztRQUNaLFdBQU0sR0FBRyxHQUFHLENBQUM7SUFHYixDQUFDO0lBRUQsd0NBQWUsR0FBZixVQUFnQixVQUFVO1FBQ3RCLElBQUksT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDN0UsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzQixPQUFPLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUd0QyxJQUFJLE1BQU0sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDMUYsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFB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QUUsQ0FBQztJQUM5RCxDQUFDO0lBN0tRLGNBQWM7UUFEMUIsaUJBQVUsRUFBRTs7T0FDQSxjQUFjLENBOEsxQjtJQUFELHFCQUFDO0NBQUEsQUE5S0QsSUE4S0M7QUE5S1ksd0NBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBhcHBsaWNhdGlvbiBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9hcHBsaWNhdGlvblwiO1xuaW1wb3J0ICogYXMgaW1hZ2VTb3VyY2VNb2R1bGUgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvaW1hZ2Utc291cmNlXCI7XG5pbXBvcnQgKiBhcyBmaWxlU3lzdGVtTW9kdWxlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ZpbGUtc3lzdGVtXCI7XG5pbXBvcnQge2FkfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91dGlscy91dGlsc1wiO1xuZGVjbGFyZSB2YXIgYW5kcm9pZDogYW55XG5kZWNsYXJlIHZhciBqYXZhOiBhbnlcbmNvbnN0IFJFU1VMVF9DT0RFX1BJQ0tFUl9JTUFHRVMgPSA5MTkyO1xuY29uc3QgY29udGV4dCA9IGFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpO1xuY29uc3QgZG9jdW1lbnRzID0gZmlsZVN5c3RlbU1vZHVsZS5rbm93bkZvbGRlcnMuZG9jdW1lbnRzKCk7XG5jb25zdCBmb2xkZXIgPSBkb2N1bWVudHMuZ2V0Rm9sZGVyKGZpbGVTeXN0ZW1Nb2R1bGUua25vd25Gb2xkZXJzLnRlbXAoKS5wYXRoKTtcbmNvbnN0IGZpbGUgPSBmb2xkZXIuZ2V0RmlsZSgndGVzdC5qcGcnKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENob29zZXJTZXJ2aWNle1xuICAgIGN1cnJlbnRJbnRlbnQ7XG4gICAgd2lkdGggPSA1MDA7XG4gICAgaGVpZ2h0ID0gNTAwO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgfVxuXG4gICAgZ2V0Q2hvb3Nlckl0ZW1zKGludGVudExpc3QpIHtcbiAgICAgICAgbGV0IGdhbGxlcnkgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChhbmRyb2lkLmNvbnRlbnQuSW50ZW50LkFDVElPTl9QSUNLKTtcbiAgICAgICAgZ2FsbGVyeS5zZXRUeXBlKFwiaW1hZ2UvKlwiKTtcbiAgICAgICAgZ2FsbGVyeS5wdXRFeHRyYShcInJldHVybi1kYXRhXCIsIHRydWUpO1xuXG5cbiAgICAgICAgbGV0IGNhbWVyYSA9IG5ldyBhbmRyb2lkLmNvbnRlbnQuSW50ZW50KGFuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5BQ1RJT05fSU1BR0VfQ0FQVFVSRSk7XG4gICAgICAgIGNhbWVyYS5wdXRFeHRyYShhbmRyb2lkLnByb3ZpZGVyLk1lZGlhU3RvcmUuRVhUUkFfT1VUUFVULCBhbmRyb2lkLm5ldC5VcmkuZnJvbUZpbGUobmV3IGphdmEuaW8uRmlsZShhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShhbmRyb2lkLm9zLkVudmlyb25tZW50LkRJUkVDVE9SWV9QSUNUVVJFUykuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKSArIFwiL1Rlc3QuanBnXCIpKSk7XG4gICAgICAgIGNhbWVyYS5wdXRFeHRyYShcInJldHVybi1kYXRhXCIsIHRydWUpO1xuXG4gICAgICAgIGludGVudExpc3QgPSB0aGlzLmFkZEludGVudHNUb0xpc3QoY29udGV4dCwgaW50ZW50TGlzdCwgZ2FsbGVyeSk7XG4gICAgICAgIGludGVudExpc3QgPSB0aGlzLmFkZEludGVudHNUb0xpc3QoY29udGV4dCwgaW50ZW50TGlzdCwgY2FtZXJhKTtcblxuXG4gICAgfVxuXG4gICAgYWRkSW50ZW50c1RvTGlzdChjb250ZXh0LCBsaXN0LCBpbnRlbnQpIHtcblxuICAgICAgICBsZXQgcmVzSW5mbyA9IGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5xdWVyeUludGVudEFjdGl2aXRpZXMoaW50ZW50LCAwKVxuICAgICAgICB2YXIgc2l6ZSA9IHJlc0luZm8uc2l6ZSgpO1xuICAgICAgICBmb3IgKHZhciBpPTA7aTxzaXplO2krKykge1xuICAgICAgICAgICAgbGV0IHBhY2thZ2VOYW1lID0gcmVzSW5mby5nZXQoaSkuYWN0aXZpdHlJbmZvLnBhY2thZ2VOYW1lO1xuICAgICAgICAgICAgbGV0IHRhcmdldGVkSW50ZW50ID0gbmV3IGFuZHJvaWQuY29udGVudC5JbnRlbnQoaW50ZW50KTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50LnBhY2thZ2VOYW1lID0gcGFja2FnZU5hbWU7XG4gICAgICAgICAgICB0YXJnZXRlZEludGVudC5pY29uID0gY29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpLmdldEFwcGxpY2F0aW9uSWNvbihwYWNrYWdlTmFtZSkuZ2V0Qml0bWFwKCk7XG4gICAgICAgICAgICB0YXJnZXRlZEludGVudC5sYWJlbCA9IGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5nZXRBcHBsaWNhdGlvbkxhYmVsKGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5nZXRBcHBsaWNhdGlvbkluZm8ocGFja2FnZU5hbWUsIDApKTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50LnNldFBhY2thZ2UocGFja2FnZU5hbWUpO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHRhcmdldGVkSW50ZW50KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGlzdDtcbiAgICB9XG5cbiAgICBnZXRJbWFnZUZyb21JbnRlbnQoaW50ZW50LCB3aWR0aCA9IDUwMCwgaGVpZ2h0ID0gNTAwKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgdGhpcy5jdXJyZW50SW50ZW50ID0gaW50ZW50LnBhY2thZ2VOYW1lO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5vbihhcHBsaWNhdGlvbi5BbmRyb2lkQXBwbGljYXRpb24uYWN0aXZpdHlSZXN1bHRFdmVudCwgKGFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uUmVzdWx0KGFyZ3MpLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmFuZHJvaWQuZm9yZWdyb3VuZEFjdGl2aXR5LnN0YXJ0QWN0aXZpdHlGb3JSZXN1bHQoaW50ZW50LCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBvblJlc3VsdChhcmdzKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgbGV0IHJlcXVlc3RDb2RlID0gYXJncy5yZXF1ZXN0Q29kZTtcbiAgICAgICAgICAgIGxldCByZXN1bHRDb2RlID0gYXJncy5yZXN1bHRDb2RlO1xuICAgICAgICAgICAgbGV0IGRhdGEgPSBhcmdzLmludGVudDtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0Q29kZSA9PT0gUkVTVUxUX0NPREVfUElDS0VSX0lNQUdFUykge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHRDb2RlID09PSBhbmRyb2lkLmFwcC5BY3Rpdml0eS5SRVNVTFRfT0spIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhdGggPSBhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShhbmRyb2lkLm9zLkVudmlyb25tZW50LkRJUkVDVE9SWV9QSUNUVVJFUykuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKSArIFwiL1Rlc3QuanBnXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRJbnRlbnQubGVuZ3RoICYmIHRoaXMuY3VycmVudEludGVudC5pbmRleE9mKCdjYW1lcmEnKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlU291cmNlTW9kdWxlLmZyb21GaWxlKHRoaXMuX2NhbGN1bGF0ZUZpbGVVcmkoZGF0YS5nZXREYXRhKCkpKS5zYXZlVG9GaWxlKHBhdGgsIFwianBnXCIsIDEwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50SW50ZW50Lmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRJbnRlbnQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFrZVBpY3R1cmUocGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHVyaSA9IGRhdGEuZ2V0RXh0cmFzKCkuZ2V0UGFyY2VsYWJsZShcImRhdGFcIilcblxuICAgICAgICAgICAgICAgICAgICAvLyBsZXQgc2VsZWN0ZWRBc3NldCA9IG5ldyBpbWFnZUFzc2V0TW9kdWxlLkltYWdlQXNzZXQodGhpcy5fY2FsY3VsYXRlRmlsZVVyaSh1cmkpKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbGljYXRpb24uYW5kcm9pZC5vZmYoYXBwbGljYXRpb24uQW5kcm9pZEFwcGxpY2F0aW9uLmFjdGl2aXR5UmVzdWx0RXZlbnQsIHRoaXMub25SZXN1bHQpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW1hZ2VTb3VyY2VNb2R1bGUuZnJvbU5hdGl2ZVNvdXJjZSh1cmkpLnRvQmFzZTY0U3RyaW5nKFwianBnXCIpKVxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhpbWFnZVNvdXJjZU1vZHVsZS5mcm9tRmlsZSh0aGlzLl9jYWxjdWxhdGVGaWxlVXJpKHVyaSkpLnRvQmFzZTY0U3RyaW5nKFwianBnXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5vZmYoYXBwbGljYXRpb24uQW5kcm9pZEFwcGxpY2F0aW9uLmFjdGl2aXR5UmVzdWx0RXZlbnQpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIHRha2VQaWN0dXJlKHVyaSl7XG4gICAgICAgIGNvbnNvbGUubG9nKGltYWdlU291cmNlTW9kdWxlLmZyb21GaWxlKG5ldyBqYXZhLmlvLkZpbGUodXJpKSkpXG4gICAgICAgIGxldCB0YWtlUGljdHVyZUludGVudCA9IG5ldyBhbmRyb2lkLmNvbnRlbnQuSW50ZW50KFwiY29tLmFuZHJvaWQuY2FtZXJhLmFjdGlvbi5DUk9QXCIpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQuc2V0RGF0YUFuZFR5cGUoYW5kcm9pZC5uZXQuVXJpLmZyb21GaWxlKG5ldyBqYXZhLmlvLkZpbGUodXJpKSksIFwiaW1hZ2UvKlwiKTtcbiAgICAgICAgICAgIHRha2VQaWN0dXJlSW50ZW50LnB1dEV4dHJhKFwiY3JvcFwiLCBcInRydWVcIik7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcImFzcGVjdFhcIiwgMSk7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcImFzcGVjdFlcIiwgMSk7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcIm91dHB1dFhcIiwgdGhpcy53aWR0aCk7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcIm91dHB1dFlcIiwgdGhpcy5oZWlnaHQpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJyZXR1cm4tZGF0YVwiLCB0cnVlKTtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmFuZHJvaWQuZm9yZWdyb3VuZEFjdGl2aXR5LnN0YXJ0QWN0aXZpdHlGb3JSZXN1bHQodGhpcy5hZGRJbnRlbnRzVG9MaXN0KGNvbnRleHQsIFtdLCB0YWtlUGljdHVyZUludGVudClbMF0sIFJFU1VMVF9DT0RFX1BJQ0tFUl9JTUFHRVMpO1xuXG4gICAgfVxuXG4gICAgX2NhbGN1bGF0ZUZpbGVVcmkodXJpKSB7XG4gICAgICAgIGxldCBEb2N1bWVudHNDb250cmFjdCA9ICg8YW55PmFuZHJvaWQucHJvdmlkZXIpLkRvY3VtZW50c0NvbnRyYWN0O1xuICAgICAgICBsZXQgaXNLaXRLYXQgPSBhbmRyb2lkLm9zLkJ1aWxkLlZFUlNJT04uU0RLX0lOVCA+PSAxOTtcbiAgICAgICAgaWYgKGlzS2l0S2F0ICYmIERvY3VtZW50c0NvbnRyYWN0LmlzRG9jdW1lbnRVcmkoYXBwbGljYXRpb24uYW5kcm9pZC5jb250ZXh0LCB1cmkpKSB7XG4gICAgICAgICAgICBsZXQgZG9jSWQsIGlkLCB0eXBlO1xuICAgICAgICAgICAgbGV0IGNvbnRlbnRVcmkgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNFeHRlcm5hbFN0b3JhZ2VEb2N1bWVudCh1cmkpKSB7XG4gICAgICAgICAgICAgICAgZG9jSWQgPSBEb2N1bWVudHNDb250cmFjdC5nZXREb2N1bWVudElkKHVyaSk7XG4gICAgICAgICAgICAgICAgaWQgPSBkb2NJZC5zcGxpdChcIjpcIilbMV07XG4gICAgICAgICAgICAgICAgdHlwZSA9IGRvY0lkLnNwbGl0KFwiOlwiKVswXTtcblxuICAgICAgICAgICAgICAgIGlmIChcInByaW1hcnlcIiA9PT0gdHlwZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZURpcmVjdG9yeSgpICsgXCIvXCIgKyBpZDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBUT0RPIGhhbmRsZSBub24tcHJpbWFyeSB2b2x1bWVzXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBNZWRpYVN0b3JlIChhbmQgZ2VuZXJhbClcbiAgICAgICAgICAgIGlmIChcImNvbnRlbnRcIiA9PT0gdXJpLmdldFNjaGVtZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YUNvbHVtbih1cmksIG51bGwsIG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRklMRVxuICAgICAgICAgICAgZWxzZSBpZiAoXCJmaWxlXCIgPT09IHVyaS5nZXRTY2hlbWUoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB1cmkuZ2V0UGF0aCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBnZXREYXRhQ29sdW1uKHVyaSwgc2VsZWN0aW9uLCBzZWxlY3Rpb25BcmdzKSB7XG4gICAgICAgIGxldCBjdXJzb3IgPSBudWxsO1xuICAgICAgICBsZXQgY29sdW1ucyA9IFthbmRyb2lkLnByb3ZpZGVyLk1lZGlhU3RvcmUuTWVkaWFDb2x1bW5zLkRBVEFdO1xuICAgICAgICBsZXQgZmlsZVBhdGg7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGN1cnNvciA9IHRoaXMuZ2V0Q29udGVudFJlc29sdmVyKCkucXVlcnkodXJpLCBjb2x1bW5zLCBzZWxlY3Rpb24sIHNlbGVjdGlvbkFyZ3MsIG51bGwpO1xuICAgICAgICAgICAgaWYgKGN1cnNvciAhPSBudWxsICYmIGN1cnNvci5tb3ZlVG9GaXJzdCgpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbHVtbl9pbmRleCA9IGN1cnNvci5nZXRDb2x1bW5JbmRleE9yVGhyb3coY29sdW1uc1swXSk7XG4gICAgICAgICAgICAgICAgZmlsZVBhdGggPSBjdXJzb3IuZ2V0U3RyaW5nKGNvbHVtbl9pbmRleCk7XG4gICAgICAgICAgICAgICAgaWYgKGZpbGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB9XG4gICAgICAgIGZpbmFsbHkge1xuICAgICAgICAgICAgaWYgKGN1cnNvcikge1xuICAgICAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpc0V4dGVybmFsU3RvcmFnZURvY3VtZW50KHVyaSkge1xuICAgICAgICByZXR1cm4gXCJjb20uYW5kcm9pZC5leHRlcm5hbHN0b3JhZ2UuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBpc0Rvd25sb2Fkc0RvY3VtZW50KHVyaSkge1xuICAgICAgICByZXR1cm4gXCJjb20uYW5kcm9pZC5wcm92aWRlcnMuZG93bmxvYWRzLmRvY3VtZW50c1wiID09PSB1cmkuZ2V0QXV0aG9yaXR5KCk7XG4gICAgfVxuXG4gICAgaXNNZWRpYURvY3VtZW50KHVyaSkge1xuICAgICAgICByZXR1cm4gXCJjb20uYW5kcm9pZC5wcm92aWRlcnMubWVkaWEuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBnZXRDb250ZW50UmVzb2x2ZXIoKSB7XG4gICAgICAgIHJldHVybiBhcHBsaWNhdGlvbi5hbmRyb2lkLm5hdGl2ZUFwcC5nZXRDb250ZW50UmVzb2x2ZXIoKTtcbiAgICB9XG59Il19
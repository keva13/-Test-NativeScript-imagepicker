"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var application = require("tns-core-modules/application");
var imageSourceModule = require("tns-core-modules/image-source");
var fileSystemModule = require("tns-core-modules/file-system");
var utils_1 = require("tns-core-modules/utils/utils");
var RESULT_CODE_PICKER_IMAGES = 9192;
var context = utils_1.ad.getApplicationContext();
var documents = fileSystemModule.knownFolders.documents();
var folder = documents.getFolder(fileSystemModule.knownFolders.temp().path);
var file = folder.getFile('test.jpg');
var ChooserService = /** @class */ (function () {
    function ChooserService() {
        this.width = 500;
        this.height = 500;
    }
    ChooserService.prototype.getChooserItems = function (intentList) {
        // let gallery = new android.content.Intent(android.content.Intent.ACTION_PICK,
        //     android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
        // gallery.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK);
        // gallery.putExtra("return-data", true);
        var gallery = new android.content.Intent(android.content.Intent.ACTION_PICK);
        gallery.setType("image/*");
        // gallery.putExtra("crop", "true");
        // gallery.putExtra("scale", false);
        // gallery.putExtra("outputX", 256);
        // gallery.putExtra("outputY", 256);
        // gallery.putExtra("aspectX", 1);
        // gallery.putExtra("aspectY", 1);
        gallery.putExtra("return-data", true);
        var camera = new android.content.Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);
        camera.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, android.net.Uri.fromFile(new java.io.File(android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg")));
        camera.putExtra("return-data", true);
        intentList = this.addIntentsToList(context, intentList, gallery);
        intentList = this.addIntentsToList(context, intentList, camera);
        console.log(intentList.length);
        console.log(intentList[0].icon);
    };
    ChooserService.prototype.addIntentsToList = function (context, list, intent) {
        var resInfo = context.getPackageManager().queryIntentActivities(intent, 0);
        var size = resInfo.size();
        for (var i = 0; i < size; i++) {
            var packageName = resInfo.get(i).activityInfo.packageName;
            var targetedIntent = new android.content.Intent(intent);
            targetedIntent.packageName = packageName;
            targetedIntent.icon = context.getPackageManager().getApplicationIcon(packageName).getBitmap();
            targetedIntent.label = context.getPackageManager().getApplicationLabel(context.getPackageManager().getApplicationInfo(packageName, 0));
            targetedIntent.setPackage(packageName);
            list.push(targetedIntent);
        }
        return list;
    };
    ChooserService.prototype.getImageFromIntent = function (intent, width, height) {
        var _this = this;
        if (width === void 0) { width = 500; }
        if (height === void 0) { height = 500; }
        this.width = width;
        this.height = height;
        this.currentIntent = intent.packageName;
        return new Promise(function (resolve, reject) {
            application.android.on(application.AndroidApplication.activityResultEvent, function (args) {
                _this.onResult(args).then(function (data) {
                    resolve(data);
                });
            });
            application.android.foregroundActivity.startActivityForResult(intent, RESULT_CODE_PICKER_IMAGES);
        });
    };
    ChooserService.prototype.onResult = function (args) {
        var _this = this;
        console.log('point0');
        return new Promise(function (resolve, reject) {
            var requestCode = args.requestCode;
            var resultCode = args.resultCode;
            var data = args.intent;
            if (requestCode === RESULT_CODE_PICKER_IMAGES) {
                console.log('point1');
                if (resultCode === android.app.Activity.RESULT_OK) {
                    console.log('point2');
                    console.log(args.intent);
                    var path = android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg";
                    console.log(_this.currentIntent);
                    if (_this.currentIntent.length && _this.currentIntent.indexOf('camera') === -1) {
                        imageSourceModule.fromFile(_this._calculateFileUri(data.getData())).saveToFile(path, "jpg", 100);
                    }
                    if (_this.currentIntent.length) {
                        _this.currentIntent = '';
                        _this.takePicture(path);
                        return;
                    }
                    var uri = data.getExtras().getParcelable("data");
                    console.log('getExtras');
                    // let selectedAsset = new imageAssetModule.ImageAsset(this._calculateFileUri(uri));
                    // application.android.off(application.AndroidApplication.activityResultEvent, this.onResult);
                    resolve(imageSourceModule.fromNativeSource(uri).toBase64String("jpg"));
                    // console.log();
                    // console.log(imageSourceModule.fromFile(this._calculateFileUri(uri)).toBase64String("jpg"));
                }
            }
        });
    };
    ChooserService.prototype.takePicture = function (uri) {
        console.log(imageSourceModule.fromFile(new java.io.File(uri)));
        var takePictureIntent = new android.content.Intent("com.android.camera.action.CROP");
        takePictureIntent.setDataAndType(android.net.Uri.fromFile(new java.io.File(uri)), "image/*");
        takePictureIntent.putExtra("crop", "true");
        takePictureIntent.putExtra("aspectX", 1);
        takePictureIntent.putExtra("aspectY", 1);
        takePictureIntent.putExtra("outputX", this.width);
        takePictureIntent.putExtra("outputY", this.height);
        takePictureIntent.putExtra("return-data", true);
        application.android.foregroundActivity.startActivityForResult(this.addIntentsToList(context, [], takePictureIntent)[0], RESULT_CODE_PICKER_IMAGES);
    };
    ChooserService.prototype._calculateFileUri = function (uri) {
        var DocumentsContract = android.provider.DocumentsContract;
        var isKitKat = android.os.Build.VERSION.SDK_INT >= 19;
        if (isKitKat && DocumentsContract.isDocumentUri(application.android.context, uri)) {
            var docId = void 0, id = void 0, type = void 0;
            var contentUri = null;
            // ExternalStorageProvider
            if (this.isExternalStorageDocument(uri)) {
                docId = DocumentsContract.getDocumentId(uri);
                id = docId.split(":")[1];
                type = docId.split(":")[0];
                if ("primary" === type.toLowerCase()) {
                    return android.os.Environment.getExternalStorageDirectory() + "/" + id;
                }
                // TODO handle non-primary volumes
            }
        }
        else {
            // MediaStore (and general)
            if ("content" === uri.getScheme()) {
                return this.getDataColumn(uri, null, null);
            }
            else if ("file" === uri.getScheme()) {
                return uri.getPath();
            }
        }
        return undefined;
    };
    ChooserService.prototype.getDataColumn = function (uri, selection, selectionArgs) {
        var cursor = null;
        var columns = [android.provider.MediaStore.MediaColumns.DATA];
        var filePath;
        try {
            cursor = this.getContentResolver().query(uri, columns, selection, selectionArgs, null);
            if (cursor != null && cursor.moveToFirst()) {
                var column_index = cursor.getColumnIndexOrThrow(columns[0]);
                filePath = cursor.getString(column_index);
                if (filePath) {
                    return filePath;
                }
            }
        }
        catch (e) {
            console.log(e);
        }
        finally {
            if (cursor) {
                cursor.close();
            }
        }
        return undefined;
    };
    ChooserService.prototype.isExternalStorageDocument = function (uri) {
        return "com.android.externalstorage.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isDownloadsDocument = function (uri) {
        return "com.android.providers.downloads.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isMediaDocument = function (uri) {
        return "com.android.providers.media.documents" === uri.getAuthority();
    };
    ChooserService.prototype.getContentResolver = function () {
        return application.android.nativeApp.getContentResolver();
    };
    ChooserService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], ChooserService);
    return ChooserService;
}());
exports.ChooserService = ChooserService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvb3Nlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hvb3Nlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDBEQUE0RDtBQUM1RCxpRUFBbUU7QUFDbkUsK0RBQWlFO0FBQ2pFLHNEQUFnRDtBQUdoRCxJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQztBQUN2QyxJQUFNLE9BQU8sR0FBRyxVQUFFLENBQUMscUJBQXFCLEVBQUUsQ0FBQztBQUMzQyxJQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDNUQsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUUsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUd4QztJQUtJO1FBSEEsVUFBSyxHQUFHLEdBQUcsQ0FBQztRQUNaLFdBQU0sR0FBRyxHQUFHLENBQUM7SUFHYixDQUFDO0lBRUQsd0NBQWUsR0FBZixVQUFnQixVQUFVO1FBRXRCLCtFQUErRTtRQUMvRSxzRUFBc0U7UUFDdEUsbUVBQW1FO1FBQ25FLHlDQUF5QztRQUN6QyxJQUFJLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdFLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDM0Isb0NBQW9DO1FBQ3BDLG9DQUFvQztRQUNwQyxvQ0FBb0M7UUFDcEMsb0NBQW9DO1FBQ3BDLGtDQUFrQztRQUNsQyxrQ0FBa0M7UUFDbEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFHdEMsSUFBSSxN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QUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ1QsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ25CLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNyQixDQUFDO0lBRUQsa0RBQXlCLEdBQXpCLFVBQTBCLEdBQUc7UUFDekIsTUFBTSxDQUFDLHVDQUF1QyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRSxDQUFDO0lBRUQsNENBQW1CLEdBQW5CLFVBQW9CLEdBQUc7UUFDbkIsTUFBTSxDQUFDLDJDQUEyQyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM5RSxDQUFDO0lBRUQsd0NBQWUsR0FBZixVQUFnQixHQUFHO1FBQ2YsTUFBTSxDQUFDLHVDQUF1QyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRSxDQUFDO0lBRUQsMkNBQWtCLEdBQWxCO1FBQ0ksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDOUQsQ0FBQztJQWxNUSxjQUFjO1FBRDFCLGlCQUFVLEVBQUU7O09BQ0EsY0FBYyxDQW1NMUI7SUFBRCxxQkFBQztDQUFBLEFBbk1ELElBbU1DO0FBbk1ZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgYXBwbGljYXRpb24gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCAqIGFzIGltYWdlU291cmNlTW9kdWxlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ltYWdlLXNvdXJjZVwiO1xuaW1wb3J0ICogYXMgZmlsZVN5c3RlbU1vZHVsZSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9maWxlLXN5c3RlbVwiO1xuaW1wb3J0IHthZH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdXRpbHMvdXRpbHNcIjtcbmRlY2xhcmUgdmFyIGFuZHJvaWQ6IGFueVxuZGVjbGFyZSB2YXIgamF2YTogYW55XG5jb25zdCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTID0gOTE5MjtcbmNvbnN0IGNvbnRleHQgPSBhZC5nZXRBcHBsaWNhdGlvbkNvbnRleHQoKTtcbmNvbnN0IGRvY3VtZW50cyA9IGZpbGVTeXN0ZW1Nb2R1bGUua25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xuY29uc3QgZm9sZGVyID0gZG9jdW1lbnRzLmdldEZvbGRlcihmaWxlU3lzdGVtTW9kdWxlLmtub3duRm9sZGVycy50ZW1wKCkucGF0aCk7XG5jb25zdCBmaWxlID0gZm9sZGVyLmdldEZpbGUoJ3Rlc3QuanBnJyk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDaG9vc2VyU2VydmljZXtcbiAgICBjdXJyZW50SW50ZW50O1xuICAgIHdpZHRoID0gNTAwO1xuICAgIGhlaWdodCA9IDUwMDtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgIH1cblxuICAgIGdldENob29zZXJJdGVtcyhpbnRlbnRMaXN0KSB7XG5cbiAgICAgICAgLy8gbGV0IGdhbGxlcnkgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChhbmRyb2lkLmNvbnRlbnQuSW50ZW50LkFDVElPTl9QSUNLLFxuICAgICAgICAvLyAgICAgYW5kcm9pZC5wcm92aWRlci5NZWRpYVN0b3JlLkltYWdlcy5NZWRpYS5FWFRFUk5BTF9DT05URU5UX1VSSSk7XG4gICAgICAgIC8vIGdhbGxlcnkuYWRkRmxhZ3MoYW5kcm9pZC5jb250ZW50LkludGVudC5GTEFHX0FDVElWSVRZX05FV19UQVNLKTtcbiAgICAgICAgLy8gZ2FsbGVyeS5wdXRFeHRyYShcInJldHVybi1kYXRhXCIsIHRydWUpO1xuICAgICAgICBsZXQgZ2FsbGVyeSA9IG5ldyBhbmRyb2lkLmNvbnRlbnQuSW50ZW50KGFuZHJvaWQuY29udGVudC5JbnRlbnQuQUNUSU9OX1BJQ0spO1xuICAgICAgICBnYWxsZXJ5LnNldFR5cGUoXCJpbWFnZS8qXCIpO1xuICAgICAgICAvLyBnYWxsZXJ5LnB1dEV4dHJhKFwiY3JvcFwiLCBcInRydWVcIik7XG4gICAgICAgIC8vIGdhbGxlcnkucHV0RXh0cmEoXCJzY2FsZVwiLCBmYWxzZSk7XG4gICAgICAgIC8vIGdhbGxlcnkucHV0RXh0cmEoXCJvdXRwdXRYXCIsIDI1Nik7XG4gICAgICAgIC8vIGdhbGxlcnkucHV0RXh0cmEoXCJvdXRwdXRZXCIsIDI1Nik7XG4gICAgICAgIC8vIGdhbGxlcnkucHV0RXh0cmEoXCJhc3BlY3RYXCIsIDEpO1xuICAgICAgICAvLyBnYWxsZXJ5LnB1dEV4dHJhKFwiYXNwZWN0WVwiLCAxKTtcbiAgICAgICAgZ2FsbGVyeS5wdXRFeHRyYShcInJldHVybi1kYXRhXCIsIHRydWUpO1xuXG5cbiAgICAgICAgbGV0IGNhbWVyYSA9IG5ldyBhbmRyb2lkLmNvbnRlbnQuSW50ZW50KGFuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5BQ1RJT05fSU1BR0VfQ0FQVFVSRSk7XG4gICAgICAgIGNhbWVyYS5wdXRFeHRyYShhbmRyb2lkLnByb3ZpZGVyLk1lZGlhU3RvcmUuRVhUUkFfT1VUUFVULCBhbmRyb2lkLm5ldC5VcmkuZnJvbUZpbGUobmV3IGphdmEuaW8uRmlsZShhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShhbmRyb2lkLm9zLkVudmlyb25tZW50LkRJUkVDVE9SWV9QSUNUVVJFUykuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKSArIFwiL1Rlc3QuanBnXCIpKSk7XG4gICAgICAgIGNhbWVyYS5wdXRFeHRyYShcInJldHVybi1kYXRhXCIsIHRydWUpO1xuXG4gICAgICAgIGludGVudExpc3QgPSB0aGlzLmFkZEludGVudHNUb0xpc3QoY29udGV4dCwgaW50ZW50TGlzdCwgZ2FsbGVyeSk7XG4gICAgICAgIGludGVudExpc3QgPSB0aGlzLmFkZEludGVudHNUb0xpc3QoY29udGV4dCwgaW50ZW50TGlzdCwgY2FtZXJhKTtcbiAgICAgICAgY29uc29sZS5sb2coaW50ZW50TGlzdC5sZW5ndGgpO1xuICAgICAgICBjb25zb2xlLmxvZyhpbnRlbnRMaXN0WzBdLmljb24pO1xuXG5cbiAgICB9XG5cbiAgICBhZGRJbnRlbnRzVG9MaXN0KGNvbnRleHQsIGxpc3QsIGludGVudCkge1xuXG4gICAgICAgIGxldCByZXNJbmZvID0gY29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpLnF1ZXJ5SW50ZW50QWN0aXZpdGllcyhpbnRlbnQsIDApXG4gICAgICAgIHZhciBzaXplID0gcmVzSW5mby5zaXplKCk7XG4gICAgICAgIGZvciAodmFyIGk9MDtpPHNpemU7aSsrKSB7XG4gICAgICAgICAgICBsZXQgcGFja2FnZU5hbWUgPSByZXNJbmZvLmdldChpKS5hY3Rpdml0eUluZm8ucGFja2FnZU5hbWU7XG4gICAgICAgICAgICBsZXQgdGFyZ2V0ZWRJbnRlbnQgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChpbnRlbnQpO1xuICAgICAgICAgICAgdGFyZ2V0ZWRJbnRlbnQucGFja2FnZU5hbWUgPSBwYWNrYWdlTmFtZTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50Lmljb24gPSBjb250ZXh0LmdldFBhY2thZ2VNYW5hZ2VyKCkuZ2V0QXBwbGljYXRpb25JY29uKHBhY2thZ2VOYW1lKS5nZXRCaXRtYXAoKTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50LmxhYmVsID0gY29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpLmdldEFwcGxpY2F0aW9uTGFiZWwoY29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpLmdldEFwcGxpY2F0aW9uSW5mbyhwYWNrYWdlTmFtZSwgMCkpO1xuICAgICAgICAgICAgdGFyZ2V0ZWRJbnRlbnQuc2V0UGFja2FnZShwYWNrYWdlTmFtZSk7XG4gICAgICAgICAgICBsaXN0LnB1c2godGFyZ2V0ZWRJbnRlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsaXN0O1xuICAgIH1cblxuICAgIGdldEltYWdlRnJvbUludGVudChpbnRlbnQsIHdpZHRoID0gNTAwLCBoZWlnaHQgPSA1MDApOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICB0aGlzLmN1cnJlbnRJbnRlbnQgPSBpbnRlbnQucGFja2FnZU5hbWU7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5hbmRyb2lkLm9uKGFwcGxpY2F0aW9uLkFuZHJvaWRBcHBsaWNhdGlvbi5hY3Rpdml0eVJlc3VsdEV2ZW50LCAoYXJncykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMub25SZXN1bHQoYXJncykudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5mb3JlZ3JvdW5kQWN0aXZpdHkuc3RhcnRBY3Rpdml0eUZvclJlc3VsdChpbnRlbnQsIFJFU1VMVF9DT0RFX1BJQ0tFUl9JTUFHRVMpO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIG9uUmVzdWx0KGFyZ3MpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncG9pbnQwJyk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGxldCByZXF1ZXN0Q29kZSA9IGFyZ3MucmVxdWVzdENvZGU7XG4gICAgICAgICAgICBsZXQgcmVzdWx0Q29kZSA9IGFyZ3MucmVzdWx0Q29kZTtcbiAgICAgICAgICAgIGxldCBkYXRhID0gYXJncy5pbnRlbnQ7XG4gICAgICAgICAgICBpZiAocmVxdWVzdENvZGUgPT09IFJFU1VMVF9DT0RFX1BJQ0tFUl9JTUFHRVMpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncG9pbnQxJylcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Q29kZSA9PT0gYW5kcm9pZC5hcHAuQWN0aXZpdHkuUkVTVUxUX09LKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdwb2ludDInKVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhhcmdzLmludGVudClcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhdGggPSBhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShhbmRyb2lkLm9zLkVudmlyb25tZW50LkRJUkVDVE9SWV9QSUNUVVJFUykuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKSArIFwiL1Rlc3QuanBnXCI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuY3VycmVudEludGVudClcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEludGVudC5sZW5ndGggJiYgdGhpcy5jdXJyZW50SW50ZW50LmluZGV4T2YoJ2NhbWVyYScpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VTb3VyY2VNb2R1bGUuZnJvbUZpbGUodGhpcy5fY2FsY3VsYXRlRmlsZVVyaShkYXRhLmdldERhdGEoKSkpLnNhdmVUb0ZpbGUocGF0aCwgXCJqcGdcIiwgMTAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRJbnRlbnQubGVuZ3RoKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEludGVudCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YWtlUGljdHVyZShwYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBsZXQgdXJpID0gZGF0YS5nZXRFeHRyYXMoKS5nZXRQYXJjZWxhYmxlKFwiZGF0YVwiKVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZ2V0RXh0cmFzJylcblxuICAgICAgICAgICAgICAgICAgICAvLyBsZXQgc2VsZWN0ZWRBc3NldCA9IG5ldyBpbWFnZUFzc2V0TW9kdWxlLkltYWdlQXNzZXQodGhpcy5fY2FsY3VsYXRlRmlsZVVyaSh1cmkpKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbGljYXRpb24uYW5kcm9pZC5vZmYoYXBwbGljYXRpb24uQW5kcm9pZEFwcGxpY2F0aW9uLmFjdGl2aXR5UmVzdWx0RXZlbnQsIHRoaXMub25SZXN1bHQpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW1hZ2VTb3VyY2VNb2R1bGUuZnJvbU5hdGl2ZVNvdXJjZSh1cmkpLnRvQmFzZTY0U3RyaW5nKFwianBnXCIpKVxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygpO1xuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhpbWFnZVNvdXJjZU1vZHVsZS5mcm9tRmlsZSh0aGlzLl9jYWxjdWxhdGVGaWxlVXJpKHVyaSkpLnRvQmFzZTY0U3RyaW5nKFwianBnXCIpKTtcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICB0YWtlUGljdHVyZSh1cmkpe1xuICAgICAgICBjb25zb2xlLmxvZyhpbWFnZVNvdXJjZU1vZHVsZS5mcm9tRmlsZShuZXcgamF2YS5pby5GaWxlKHVyaSkpKVxuICAgICAgICBsZXQgdGFrZVBpY3R1cmVJbnRlbnQgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChcImNvbS5hbmRyb2lkLmNhbWVyYS5hY3Rpb24uQ1JPUFwiKTtcbiAgICAgICAgICAgIHRha2VQaWN0dXJlSW50ZW50LnNldERhdGFBbmRUeXBlKGFuZHJvaWQubmV0LlVyaS5mcm9tRmlsZShuZXcgamF2YS5pby5GaWxlKHVyaSkpLCBcImltYWdlLypcIik7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcImNyb3BcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJhc3BlY3RYXCIsIDEpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJhc3BlY3RZXCIsIDEpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJvdXRwdXRYXCIsIHRoaXMud2lkdGgpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJvdXRwdXRZXCIsIHRoaXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIHRha2VQaWN0dXJlSW50ZW50LnB1dEV4dHJhKFwicmV0dXJuLWRhdGFcIiwgdHJ1ZSk7XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5hbmRyb2lkLmZvcmVncm91bmRBY3Rpdml0eS5zdGFydEFjdGl2aXR5Rm9yUmVzdWx0KHRoaXMuYWRkSW50ZW50c1RvTGlzdChjb250ZXh0LCBbXSwgdGFrZVBpY3R1cmVJbnRlbnQpWzBdLCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTKTtcblxuICAgIH1cblxuICAgIF9jYWxjdWxhdGVGaWxlVXJpKHVyaSkge1xuICAgICAgICBsZXQgRG9jdW1lbnRzQ29udHJhY3QgPSAoPGFueT5hbmRyb2lkLnByb3ZpZGVyKS5Eb2N1bWVudHNDb250cmFjdDtcbiAgICAgICAgbGV0IGlzS2l0S2F0ID0gYW5kcm9pZC5vcy5CdWlsZC5WRVJTSU9OLlNES19JTlQgPj0gMTk7XG4gICAgICAgIGlmIChpc0tpdEthdCAmJiBEb2N1bWVudHNDb250cmFjdC5pc0RvY3VtZW50VXJpKGFwcGxpY2F0aW9uLmFuZHJvaWQuY29udGV4dCwgdXJpKSkge1xuICAgICAgICAgICAgbGV0IGRvY0lkLCBpZCwgdHlwZTtcbiAgICAgICAgICAgIGxldCBjb250ZW50VXJpID0gbnVsbDtcbiAgICAgICAgICAgIC8vIEV4dGVybmFsU3RvcmFnZVByb3ZpZGVyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0V4dGVybmFsU3RvcmFnZURvY3VtZW50KHVyaSkpIHtcbiAgICAgICAgICAgICAgICBkb2NJZCA9IERvY3VtZW50c0NvbnRyYWN0LmdldERvY3VtZW50SWQodXJpKTtcbiAgICAgICAgICAgICAgICBpZCA9IGRvY0lkLnNwbGl0KFwiOlwiKVsxXTtcbiAgICAgICAgICAgICAgICB0eXBlID0gZG9jSWQuc3BsaXQoXCI6XCIpWzBdO1xuXG4gICAgICAgICAgICAgICAgaWYgKFwicHJpbWFyeVwiID09PSB0eXBlLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZHJvaWQub3MuRW52aXJvbm1lbnQuZ2V0RXh0ZXJuYWxTdG9yYWdlRGlyZWN0b3J5KCkgKyBcIi9cIiArIGlkO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIFRPRE8gaGFuZGxlIG5vbi1wcmltYXJ5IHZvbHVtZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIE1lZGlhU3RvcmUgKGFuZCBnZW5lcmFsKVxuICAgICAgICAgICAgaWYgKFwiY29udGVudFwiID09PSB1cmkuZ2V0U2NoZW1lKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhQ29sdW1uKHVyaSwgbnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGSUxFXG4gICAgICAgICAgICBlbHNlIGlmIChcImZpbGVcIiA9PT0gdXJpLmdldFNjaGVtZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVyaS5nZXRQYXRoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGdldERhdGFDb2x1bW4odXJpLCBzZWxlY3Rpb24sIHNlbGVjdGlvbkFyZ3MpIHtcbiAgICAgICAgbGV0IGN1cnNvciA9IG51bGw7XG4gICAgICAgIGxldCBjb2x1bW5zID0gW2FuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5NZWRpYUNvbHVtbnMuREFUQV07XG4gICAgICAgIGxldCBmaWxlUGF0aDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY3Vyc29yID0gdGhpcy5nZXRDb250ZW50UmVzb2x2ZXIoKS5xdWVyeSh1cmksIGNvbHVtbnMsIHNlbGVjdGlvbiwgc2VsZWN0aW9uQXJncywgbnVsbCk7XG4gICAgICAgICAgICBpZiAoY3Vyc29yICE9IG51bGwgJiYgY3Vyc29yLm1vdmVUb0ZpcnN0KCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgY29sdW1uX2luZGV4ID0gY3Vyc29yLmdldENvbHVtbkluZGV4T3JUaHJvdyhjb2x1bW5zWzBdKTtcbiAgICAgICAgICAgICAgICBmaWxlUGF0aCA9IGN1cnNvci5nZXRTdHJpbmcoY29sdW1uX2luZGV4KTtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbGVQYXRoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIH1cbiAgICAgICAgZmluYWxseSB7XG4gICAgICAgICAgICBpZiAoY3Vyc29yKSB7XG4gICAgICAgICAgICAgICAgY3Vyc29yLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlzRXh0ZXJuYWxTdG9yYWdlRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLmV4dGVybmFsc3RvcmFnZS5kb2N1bWVudHNcIiA9PT0gdXJpLmdldEF1dGhvcml0eSgpO1xuICAgIH1cblxuICAgIGlzRG93bmxvYWRzRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLnByb3ZpZGVycy5kb3dubG9hZHMuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBpc01lZGlhRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLnByb3ZpZGVycy5tZWRpYS5kb2N1bWVudHNcIiA9PT0gdXJpLmdldEF1dGhvcml0eSgpO1xuICAgIH1cblxuICAgIGdldENvbnRlbnRSZXNvbHZlcigpIHtcbiAgICAgICAgcmV0dXJuIGFwcGxpY2F0aW9uLmFuZHJvaWQubmF0aXZlQXBwLmdldENvbnRlbnRSZXNvbHZlcigpO1xuICAgIH1cbn0iXX0=
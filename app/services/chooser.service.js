"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var application = require("tns-core-modules/application");
var imageSourceModule = require("tns-core-modules/image-source");
var fileSystemModule = require("tns-core-modules/file-system");
var utils_1 = require("tns-core-modules/utils/utils");
var RESULT_CODE_PICKER_IMAGES = 9192;
var context = utils_1.ad.getApplicationContext();
var documents = fileSystemModule.knownFolders.documents();
var folder = documents.getFolder(fileSystemModule.knownFolders.temp().path);
var file = folder.getFile('test.jpg');
var ChooserService = /** @class */ (function () {
    function ChooserService() {
        this.width = 500;
        this.height = 500;
    }
    ChooserService.prototype.getChooserItems = function (intentList) {
        var gallery = new android.content.Intent(android.content.Intent.ACTION_PICK);
        gallery.setType("image/*");
        gallery.putExtra("return-data", true);
        var camera = new android.content.Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);
        camera.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, android.net.Uri.fromFile(new java.io.File(android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg")));
        camera.putExtra("return-data", true);
        intentList = this.addIntentsToList(context, intentList, gallery);
        intentList = this.addIntentsToList(context, intentList, camera);
        console.log(intentList.length);
        console.log(intentList[0].icon);
    };
    ChooserService.prototype.addIntentsToList = function (context, list, intent) {
        var resInfo = context.getPackageManager().queryIntentActivities(intent, 0);
        var size = resInfo.size();
        for (var i = 0; i < size; i++) {
            var packageName = resInfo.get(i).activityInfo.packageName;
            var targetedIntent = new android.content.Intent(intent);
            targetedIntent.packageName = packageName;
            targetedIntent.icon = context.getPackageManager().getApplicationIcon(packageName).getBitmap();
            targetedIntent.label = context.getPackageManager().getApplicationLabel(context.getPackageManager().getApplicationInfo(packageName, 0));
            targetedIntent.setPackage(packageName);
            list.push(targetedIntent);
        }
        return list;
    };
    ChooserService.prototype.getImageFromIntent = function (intent, width, height) {
        var _this = this;
        if (width === void 0) { width = 500; }
        if (height === void 0) { height = 500; }
        this.width = width;
        this.height = height;
        this.currentIntent = intent.packageName;
        return new Promise(function (resolve, reject) {
            application.android.on(application.AndroidApplication.activityResultEvent, function (args) {
                _this.onResult(args).then(function (data) {
                    resolve(data);
                });
            });
            application.android.foregroundActivity.startActivityForResult(intent, RESULT_CODE_PICKER_IMAGES);
        });
    };
    ChooserService.prototype.onResult = function (args) {
        var _this = this;
        console.log('point0');
        return new Promise(function (resolve, reject) {
            var requestCode = args.requestCode;
            var resultCode = args.resultCode;
            var data = args.intent;
            if (requestCode === RESULT_CODE_PICKER_IMAGES) {
                console.log('point1');
                if (resultCode === android.app.Activity.RESULT_OK) {
                    console.log('point2');
                    console.log(args.intent);
                    var path = android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_PICTURES).getAbsolutePath().toString() + "/Test.jpg";
                    console.log(_this.currentIntent);
                    if (_this.currentIntent.length && _this.currentIntent.indexOf('camera') === -1) {
                        imageSourceModule.fromFile(_this._calculateFileUri(data.getData())).saveToFile(path, "jpg", 100);
                    }
                    if (_this.currentIntent.length) {
                        _this.currentIntent = '';
                        _this.takePicture(path);
                        return;
                    }
                    var uri = data.getExtras().getParcelable("data");
                    console.log('getExtras');
                    // let selectedAsset = new imageAssetModule.ImageAsset(this._calculateFileUri(uri));
                    // application.android.off(application.AndroidApplication.activityResultEvent, this.onResult);
                    resolve(imageSourceModule.fromNativeSource(uri).toBase64String("jpg"));
                    // console.log();
                    // console.log(imageSourceModule.fromFile(this._calculateFileUri(uri)).toBase64String("jpg"));
                    application.android.off(application.AndroidApplication.activityResultEvent);
                }
            }
        });
    };
    ChooserService.prototype.takePicture = function (uri) {
        console.log(imageSourceModule.fromFile(new java.io.File(uri)));
        var takePictureIntent = new android.content.Intent("com.android.camera.action.CROP");
        takePictureIntent.setDataAndType(android.net.Uri.fromFile(new java.io.File(uri)), "image/*");
        takePictureIntent.putExtra("crop", "true");
        takePictureIntent.putExtra("aspectX", 1);
        takePictureIntent.putExtra("aspectY", 1);
        takePictureIntent.putExtra("outputX", this.width);
        takePictureIntent.putExtra("outputY", this.height);
        takePictureIntent.putExtra("return-data", true);
        application.android.foregroundActivity.startActivityForResult(this.addIntentsToList(context, [], takePictureIntent)[0], RESULT_CODE_PICKER_IMAGES);
    };
    ChooserService.prototype._calculateFileUri = function (uri) {
        var DocumentsContract = android.provider.DocumentsContract;
        var isKitKat = android.os.Build.VERSION.SDK_INT >= 19;
        if (isKitKat && DocumentsContract.isDocumentUri(application.android.context, uri)) {
            var docId = void 0, id = void 0, type = void 0;
            var contentUri = null;
            // ExternalStorageProvider
            if (this.isExternalStorageDocument(uri)) {
                docId = DocumentsContract.getDocumentId(uri);
                id = docId.split(":")[1];
                type = docId.split(":")[0];
                if ("primary" === type.toLowerCase()) {
                    return android.os.Environment.getExternalStorageDirectory() + "/" + id;
                }
                // TODO handle non-primary volumes
            }
        }
        else {
            // MediaStore (and general)
            if ("content" === uri.getScheme()) {
                return this.getDataColumn(uri, null, null);
            }
            else if ("file" === uri.getScheme()) {
                return uri.getPath();
            }
        }
        return undefined;
    };
    ChooserService.prototype.getDataColumn = function (uri, selection, selectionArgs) {
        var cursor = null;
        var columns = [android.provider.MediaStore.MediaColumns.DATA];
        var filePath;
        try {
            cursor = this.getContentResolver().query(uri, columns, selection, selectionArgs, null);
            if (cursor != null && cursor.moveToFirst()) {
                var column_index = cursor.getColumnIndexOrThrow(columns[0]);
                filePath = cursor.getString(column_index);
                if (filePath) {
                    return filePath;
                }
            }
        }
        catch (e) {
            console.log(e);
        }
        finally {
            if (cursor) {
                cursor.close();
            }
        }
        return undefined;
    };
    ChooserService.prototype.isExternalStorageDocument = function (uri) {
        return "com.android.externalstorage.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isDownloadsDocument = function (uri) {
        return "com.android.providers.downloads.documents" === uri.getAuthority();
    };
    ChooserService.prototype.isMediaDocument = function (uri) {
        return "com.android.providers.media.documents" === uri.getAuthority();
    };
    ChooserService.prototype.getContentResolver = function () {
        return application.android.nativeApp.getContentResolver();
    };
    ChooserService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], ChooserService);
    return ChooserService;
}());
exports.ChooserService = ChooserService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvb3Nlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hvb3Nlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDBEQUE0RDtBQUM1RCxpRUFBbUU7QUFDbkUsK0RBQWlFO0FBQ2pFLHNEQUFnRDtBQUdoRCxJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQztBQUN2QyxJQUFNLE9BQU8sR0FBRyxVQUFFLENBQUMscUJBQXFCLEVBQUUsQ0FBQztBQUMzQyxJQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDNUQsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUUsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUd4QztJQUtJO1FBSEEsVUFBSyxHQUFHLEdBQUcsQ0FBQztRQUNaLFdBQU0sR0FBRyxHQUFHLENBQUM7SUFHYixDQUFDO0lBRUQsd0NBQWUsR0FBZixVQUFnQixVQUFVO1FBQ3RCLElBQUksT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDN0UsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzQixPQUFPLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUd0QyxJQUFJLE1BQU0sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDMUYsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsaUNBQWlDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdFAsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFckMsVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2pFLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNoRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUdwQyxDQUFDO0lBRUQseUNBQWdCLEdBQWhCLFVBQWlCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTTtRQUVsQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDMUUsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBQyxDQUFDLEdBQUMsSUFBSSxFQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdEIsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO1lBQzFELElBQUksY0FBYyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsY0FBYyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7WUFDekMsY0FBYyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUM5RixjQUFjLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZJLGNBQWMsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsMkNBQWtCLEdBQWxCLFVBQW1CLE1BQU0sRUFBRSxLQUFXLEVBQUUsTUFBWTtRQUFwRCxpQkFZQztRQVowQixzQkFBQSxFQUFBLFdBQVc7UUFBRSx1QkFBQSxFQUFBLFlBQVk7UUFDaEQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxtQkFBbUIsRUFBRSxVQUFDLElBQUk7Z0JBQzVFLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBSTtvQkFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO2dCQUNqQixDQUFDLENBQUMsQ0FBQTtZQUNOLENBQUMsQ0FBQyxDQUFDO1lBQ0gsV0FBVyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUseUJBQXlCLENBQUMsQ0FBQztRQUNyRyxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFFRCxpQ0FBUSxHQUFSLFVBQVMsSUFBSTtRQUFiLGlCQXFDQztRQXBDRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBRS9CLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDbkMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNqQyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ3ZCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsS0FBSyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7Z0JBQzVDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7Z0JBQ3JCLEVBQUUsQ0FBQyxDQUFDLFVBQVUsS0FBSyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO29CQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO29CQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQkFDeEIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsaUNBQWlDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxXQUFXLENBQUM7b0JBQzFKLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO29CQUMvQixFQUFFLENBQUMsQ0FBQyxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sSUFBSSxLQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzNFLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxLQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDcEcsQ0FBQztvQkFFRCxFQUFFLENBQUMsQ0FBQyxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUM7d0JBQzNCLEtBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO3dCQUN4QixLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUN2QixNQUFNLENBQUM7b0JBQ1gsQ0FBQztvQkFDRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO29CQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO29CQUV4QixvRkFBb0Y7b0JBQ3BGLDhGQUE4RjtvQkFFOUYsT0FBTyxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO29CQUN0RSxpQkFBaUI7b0JBQ2pCLDhGQUE4RjtvQkFDOUYsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUE7Z0JBQzNFLENBQUM7WUFDVCxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDO0lBRUQsb0NBQVcsR0FBWCxVQUFZLEdBQUc7UUFDWCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUM5RCxJQUFJLGlCQUFpQixHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUNqRixpQkFBaUIsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUM3RixpQkFBaUIsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzNDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDekMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6QyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNuRCxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hELFdBQVcsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0lBRTNKLENBQUM7SUFFRCwwQ0FBaUIsR0FBakIsVUFBa0IsR0FBRztRQUNqQixJQUFJLGlCQUFpQixHQUFTLE9BQU8sQ0FBQyxRQUFTLENBQUMsaUJBQWlCLENBQUM7UUFDbEUsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDdEQsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEYsSUFBSSxLQUFLLFNBQUEsRUFBRSxFQUFFLFNBQUEsRUFBRSxJQUFJLFNBQUEsQ0FBQztZQUNwQixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdEIsMEJBQTBCO1lBQzFCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RDLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFM0IsRUFBRSxDQUFDLENBQUMsU0FBUyxLQUFLLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUM7Z0JBQzNFLENBQUM7Z0JBRUQsa0NBQWtDO1lBQ3RDLENBQUM7UUFDTCxDQUFDO1FBQ0QsSUFBSSxDQUFDLENBQUM7WUFDRiwyQkFBMkI7WUFDM0IsRUFBRSxDQUFDLENBQUMsU0FBUyxLQUFLLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDL0MsQ0FBQztZQUVELElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDbEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN6QixDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sQ0FBQyxTQUFTLENBQUM7SUFDckIsQ0FBQztJQUVELHNDQUFhLEdBQWIsVUFBYyxHQUFHLEVBQUUsU0FBUyxFQUFFLGFBQWE7UUFDdkMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlELElBQUksUUFBUSxDQUFDO1FBRWIsSUFBSSxDQUFDO1lBQ0QsTUFBTSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkYsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksSUFBSSxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVELFFBQVEsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUMxQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUNYLE1BQU0sQ0FBQyxRQUFRLENBQUM7Z0JBQ3BCLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25CLENBQUM7Z0JBQ08sQ0FBQztZQUNMLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ1QsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ25CLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNyQixDQUFDO0lBRUQsa0RBQXlCLEdBQXpCLFVBQTBCLEdBQUc7UUFDekIsTUFBTSxDQUFDLHVDQUF1QyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRSxDQUFDO0lBRUQsNENBQW1CLEdBQW5CLFVBQW9CLEdBQUc7UUFDbkIsTUFBTSxDQUFDLDJDQUEyQyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM5RSxDQUFDO0lBRUQsd0NBQWUsR0FBZixVQUFnQixHQUFHO1FBQ2YsTUFBTSxDQUFDLHVDQUF1QyxLQUFLLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRSxDQUFDO0lBRUQsMkNBQWtCLEdBQWxCO1FBQ0ksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDOUQsQ0FBQztJQXZMUSxjQUFjO1FBRDFCLGlCQUFVLEVBQUU7O09BQ0EsY0FBYyxDQXdMMUI7SUFBRCxxQkFBQztDQUFBLEFBeExELElBd0xDO0FBeExZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgYXBwbGljYXRpb24gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCAqIGFzIGltYWdlU291cmNlTW9kdWxlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ltYWdlLXNvdXJjZVwiO1xuaW1wb3J0ICogYXMgZmlsZVN5c3RlbU1vZHVsZSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9maWxlLXN5c3RlbVwiO1xuaW1wb3J0IHthZH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdXRpbHMvdXRpbHNcIjtcbmRlY2xhcmUgdmFyIGFuZHJvaWQ6IGFueVxuZGVjbGFyZSB2YXIgamF2YTogYW55XG5jb25zdCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTID0gOTE5MjtcbmNvbnN0IGNvbnRleHQgPSBhZC5nZXRBcHBsaWNhdGlvbkNvbnRleHQoKTtcbmNvbnN0IGRvY3VtZW50cyA9IGZpbGVTeXN0ZW1Nb2R1bGUua25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xuY29uc3QgZm9sZGVyID0gZG9jdW1lbnRzLmdldEZvbGRlcihmaWxlU3lzdGVtTW9kdWxlLmtub3duRm9sZGVycy50ZW1wKCkucGF0aCk7XG5jb25zdCBmaWxlID0gZm9sZGVyLmdldEZpbGUoJ3Rlc3QuanBnJyk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDaG9vc2VyU2VydmljZXtcbiAgICBjdXJyZW50SW50ZW50O1xuICAgIHdpZHRoID0gNTAwO1xuICAgIGhlaWdodCA9IDUwMDtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgIH1cblxuICAgIGdldENob29zZXJJdGVtcyhpbnRlbnRMaXN0KSB7XG4gICAgICAgIGxldCBnYWxsZXJ5ID0gbmV3IGFuZHJvaWQuY29udGVudC5JbnRlbnQoYW5kcm9pZC5jb250ZW50LkludGVudC5BQ1RJT05fUElDSyk7XG4gICAgICAgIGdhbGxlcnkuc2V0VHlwZShcImltYWdlLypcIik7XG4gICAgICAgIGdhbGxlcnkucHV0RXh0cmEoXCJyZXR1cm4tZGF0YVwiLCB0cnVlKTtcblxuXG4gICAgICAgIGxldCBjYW1lcmEgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChhbmRyb2lkLnByb3ZpZGVyLk1lZGlhU3RvcmUuQUNUSU9OX0lNQUdFX0NBUFRVUkUpO1xuICAgICAgICBjYW1lcmEucHV0RXh0cmEoYW5kcm9pZC5wcm92aWRlci5NZWRpYVN0b3JlLkVYVFJBX09VVFBVVCwgYW5kcm9pZC5uZXQuVXJpLmZyb21GaWxlKG5ldyBqYXZhLmlvLkZpbGUoYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5nZXRFeHRlcm5hbFN0b3JhZ2VQdWJsaWNEaXJlY3RvcnkoYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5ESVJFQ1RPUllfUElDVFVSRVMpLmdldEFic29sdXRlUGF0aCgpLnRvU3RyaW5nKCkgKyBcIi9UZXN0LmpwZ1wiKSkpO1xuICAgICAgICBjYW1lcmEucHV0RXh0cmEoXCJyZXR1cm4tZGF0YVwiLCB0cnVlKTtcblxuICAgICAgICBpbnRlbnRMaXN0ID0gdGhpcy5hZGRJbnRlbnRzVG9MaXN0KGNvbnRleHQsIGludGVudExpc3QsIGdhbGxlcnkpO1xuICAgICAgICBpbnRlbnRMaXN0ID0gdGhpcy5hZGRJbnRlbnRzVG9MaXN0KGNvbnRleHQsIGludGVudExpc3QsIGNhbWVyYSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGludGVudExpc3QubGVuZ3RoKTtcbiAgICAgICAgY29uc29sZS5sb2coaW50ZW50TGlzdFswXS5pY29uKTtcblxuXG4gICAgfVxuXG4gICAgYWRkSW50ZW50c1RvTGlzdChjb250ZXh0LCBsaXN0LCBpbnRlbnQpIHtcblxuICAgICAgICBsZXQgcmVzSW5mbyA9IGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5xdWVyeUludGVudEFjdGl2aXRpZXMoaW50ZW50LCAwKVxuICAgICAgICB2YXIgc2l6ZSA9IHJlc0luZm8uc2l6ZSgpO1xuICAgICAgICBmb3IgKHZhciBpPTA7aTxzaXplO2krKykge1xuICAgICAgICAgICAgbGV0IHBhY2thZ2VOYW1lID0gcmVzSW5mby5nZXQoaSkuYWN0aXZpdHlJbmZvLnBhY2thZ2VOYW1lO1xuICAgICAgICAgICAgbGV0IHRhcmdldGVkSW50ZW50ID0gbmV3IGFuZHJvaWQuY29udGVudC5JbnRlbnQoaW50ZW50KTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50LnBhY2thZ2VOYW1lID0gcGFja2FnZU5hbWU7XG4gICAgICAgICAgICB0YXJnZXRlZEludGVudC5pY29uID0gY29udGV4dC5nZXRQYWNrYWdlTWFuYWdlcigpLmdldEFwcGxpY2F0aW9uSWNvbihwYWNrYWdlTmFtZSkuZ2V0Qml0bWFwKCk7XG4gICAgICAgICAgICB0YXJnZXRlZEludGVudC5sYWJlbCA9IGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5nZXRBcHBsaWNhdGlvbkxhYmVsKGNvbnRleHQuZ2V0UGFja2FnZU1hbmFnZXIoKS5nZXRBcHBsaWNhdGlvbkluZm8ocGFja2FnZU5hbWUsIDApKTtcbiAgICAgICAgICAgIHRhcmdldGVkSW50ZW50LnNldFBhY2thZ2UocGFja2FnZU5hbWUpO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHRhcmdldGVkSW50ZW50KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGlzdDtcbiAgICB9XG5cbiAgICBnZXRJbWFnZUZyb21JbnRlbnQoaW50ZW50LCB3aWR0aCA9IDUwMCwgaGVpZ2h0ID0gNTAwKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgdGhpcy5jdXJyZW50SW50ZW50ID0gaW50ZW50LnBhY2thZ2VOYW1lO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5vbihhcHBsaWNhdGlvbi5BbmRyb2lkQXBwbGljYXRpb24uYWN0aXZpdHlSZXN1bHRFdmVudCwgKGFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uUmVzdWx0KGFyZ3MpLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmFuZHJvaWQuZm9yZWdyb3VuZEFjdGl2aXR5LnN0YXJ0QWN0aXZpdHlGb3JSZXN1bHQoaW50ZW50LCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTKTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBvblJlc3VsdChhcmdzKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3BvaW50MCcpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICBsZXQgcmVxdWVzdENvZGUgPSBhcmdzLnJlcXVlc3RDb2RlO1xuICAgICAgICAgICAgbGV0IHJlc3VsdENvZGUgPSBhcmdzLnJlc3VsdENvZGU7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IGFyZ3MuaW50ZW50O1xuICAgICAgICAgICAgaWYgKHJlcXVlc3RDb2RlID09PSBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3BvaW50MScpXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdENvZGUgPT09IGFuZHJvaWQuYXBwLkFjdGl2aXR5LlJFU1VMVF9PSykge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncG9pbnQyJylcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXJncy5pbnRlbnQpXG4gICAgICAgICAgICAgICAgICAgIGxldCBwYXRoID0gYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5nZXRFeHRlcm5hbFN0b3JhZ2VQdWJsaWNEaXJlY3RvcnkoYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5ESVJFQ1RPUllfUElDVFVSRVMpLmdldEFic29sdXRlUGF0aCgpLnRvU3RyaW5nKCkgKyBcIi9UZXN0LmpwZ1wiO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmN1cnJlbnRJbnRlbnQpXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRJbnRlbnQubGVuZ3RoICYmIHRoaXMuY3VycmVudEludGVudC5pbmRleE9mKCdjYW1lcmEnKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlU291cmNlTW9kdWxlLmZyb21GaWxlKHRoaXMuX2NhbGN1bGF0ZUZpbGVVcmkoZGF0YS5nZXREYXRhKCkpKS5zYXZlVG9GaWxlKHBhdGgsIFwianBnXCIsIDEwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50SW50ZW50Lmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRJbnRlbnQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFrZVBpY3R1cmUocGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHVyaSA9IGRhdGEuZ2V0RXh0cmFzKCkuZ2V0UGFyY2VsYWJsZShcImRhdGFcIilcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2dldEV4dHJhcycpXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gbGV0IHNlbGVjdGVkQXNzZXQgPSBuZXcgaW1hZ2VBc3NldE1vZHVsZS5JbWFnZUFzc2V0KHRoaXMuX2NhbGN1bGF0ZUZpbGVVcmkodXJpKSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGFwcGxpY2F0aW9uLmFuZHJvaWQub2ZmKGFwcGxpY2F0aW9uLkFuZHJvaWRBcHBsaWNhdGlvbi5hY3Rpdml0eVJlc3VsdEV2ZW50LCB0aGlzLm9uUmVzdWx0KTtcblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGltYWdlU291cmNlTW9kdWxlLmZyb21OYXRpdmVTb3VyY2UodXJpKS50b0Jhc2U2NFN0cmluZyhcImpwZ1wiKSlcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coaW1hZ2VTb3VyY2VNb2R1bGUuZnJvbUZpbGUodGhpcy5fY2FsY3VsYXRlRmlsZVVyaSh1cmkpKS50b0Jhc2U2NFN0cmluZyhcImpwZ1wiKSk7XG4gICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uLmFuZHJvaWQub2ZmKGFwcGxpY2F0aW9uLkFuZHJvaWRBcHBsaWNhdGlvbi5hY3Rpdml0eVJlc3VsdEV2ZW50KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICB0YWtlUGljdHVyZSh1cmkpe1xuICAgICAgICBjb25zb2xlLmxvZyhpbWFnZVNvdXJjZU1vZHVsZS5mcm9tRmlsZShuZXcgamF2YS5pby5GaWxlKHVyaSkpKVxuICAgICAgICBsZXQgdGFrZVBpY3R1cmVJbnRlbnQgPSBuZXcgYW5kcm9pZC5jb250ZW50LkludGVudChcImNvbS5hbmRyb2lkLmNhbWVyYS5hY3Rpb24uQ1JPUFwiKTtcbiAgICAgICAgICAgIHRha2VQaWN0dXJlSW50ZW50LnNldERhdGFBbmRUeXBlKGFuZHJvaWQubmV0LlVyaS5mcm9tRmlsZShuZXcgamF2YS5pby5GaWxlKHVyaSkpLCBcImltYWdlLypcIik7XG4gICAgICAgICAgICB0YWtlUGljdHVyZUludGVudC5wdXRFeHRyYShcImNyb3BcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJhc3BlY3RYXCIsIDEpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJhc3BlY3RZXCIsIDEpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJvdXRwdXRYXCIsIHRoaXMud2lkdGgpO1xuICAgICAgICAgICAgdGFrZVBpY3R1cmVJbnRlbnQucHV0RXh0cmEoXCJvdXRwdXRZXCIsIHRoaXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIHRha2VQaWN0dXJlSW50ZW50LnB1dEV4dHJhKFwicmV0dXJuLWRhdGFcIiwgdHJ1ZSk7XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5hbmRyb2lkLmZvcmVncm91bmRBY3Rpdml0eS5zdGFydEFjdGl2aXR5Rm9yUmVzdWx0KHRoaXMuYWRkSW50ZW50c1RvTGlzdChjb250ZXh0LCBbXSwgdGFrZVBpY3R1cmVJbnRlbnQpWzBdLCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTKTtcblxuICAgIH1cblxuICAgIF9jYWxjdWxhdGVGaWxlVXJpKHVyaSkge1xuICAgICAgICBsZXQgRG9jdW1lbnRzQ29udHJhY3QgPSAoPGFueT5hbmRyb2lkLnByb3ZpZGVyKS5Eb2N1bWVudHNDb250cmFjdDtcbiAgICAgICAgbGV0IGlzS2l0S2F0ID0gYW5kcm9pZC5vcy5CdWlsZC5WRVJTSU9OLlNES19JTlQgPj0gMTk7XG4gICAgICAgIGlmIChpc0tpdEthdCAmJiBEb2N1bWVudHNDb250cmFjdC5pc0RvY3VtZW50VXJpKGFwcGxpY2F0aW9uLmFuZHJvaWQuY29udGV4dCwgdXJpKSkge1xuICAgICAgICAgICAgbGV0IGRvY0lkLCBpZCwgdHlwZTtcbiAgICAgICAgICAgIGxldCBjb250ZW50VXJpID0gbnVsbDtcbiAgICAgICAgICAgIC8vIEV4dGVybmFsU3RvcmFnZVByb3ZpZGVyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0V4dGVybmFsU3RvcmFnZURvY3VtZW50KHVyaSkpIHtcbiAgICAgICAgICAgICAgICBkb2NJZCA9IERvY3VtZW50c0NvbnRyYWN0LmdldERvY3VtZW50SWQodXJpKTtcbiAgICAgICAgICAgICAgICBpZCA9IGRvY0lkLnNwbGl0KFwiOlwiKVsxXTtcbiAgICAgICAgICAgICAgICB0eXBlID0gZG9jSWQuc3BsaXQoXCI6XCIpWzBdO1xuXG4gICAgICAgICAgICAgICAgaWYgKFwicHJpbWFyeVwiID09PSB0eXBlLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZHJvaWQub3MuRW52aXJvbm1lbnQuZ2V0RXh0ZXJuYWxTdG9yYWdlRGlyZWN0b3J5KCkgKyBcIi9cIiArIGlkO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIFRPRE8gaGFuZGxlIG5vbi1wcmltYXJ5IHZvbHVtZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIE1lZGlhU3RvcmUgKGFuZCBnZW5lcmFsKVxuICAgICAgICAgICAgaWYgKFwiY29udGVudFwiID09PSB1cmkuZ2V0U2NoZW1lKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhQ29sdW1uKHVyaSwgbnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGSUxFXG4gICAgICAgICAgICBlbHNlIGlmIChcImZpbGVcIiA9PT0gdXJpLmdldFNjaGVtZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVyaS5nZXRQYXRoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGdldERhdGFDb2x1bW4odXJpLCBzZWxlY3Rpb24sIHNlbGVjdGlvbkFyZ3MpIHtcbiAgICAgICAgbGV0IGN1cnNvciA9IG51bGw7XG4gICAgICAgIGxldCBjb2x1bW5zID0gW2FuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5NZWRpYUNvbHVtbnMuREFUQV07XG4gICAgICAgIGxldCBmaWxlUGF0aDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY3Vyc29yID0gdGhpcy5nZXRDb250ZW50UmVzb2x2ZXIoKS5xdWVyeSh1cmksIGNvbHVtbnMsIHNlbGVjdGlvbiwgc2VsZWN0aW9uQXJncywgbnVsbCk7XG4gICAgICAgICAgICBpZiAoY3Vyc29yICE9IG51bGwgJiYgY3Vyc29yLm1vdmVUb0ZpcnN0KCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgY29sdW1uX2luZGV4ID0gY3Vyc29yLmdldENvbHVtbkluZGV4T3JUaHJvdyhjb2x1bW5zWzBdKTtcbiAgICAgICAgICAgICAgICBmaWxlUGF0aCA9IGN1cnNvci5nZXRTdHJpbmcoY29sdW1uX2luZGV4KTtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbGVQYXRoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIH1cbiAgICAgICAgZmluYWxseSB7XG4gICAgICAgICAgICBpZiAoY3Vyc29yKSB7XG4gICAgICAgICAgICAgICAgY3Vyc29yLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlzRXh0ZXJuYWxTdG9yYWdlRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLmV4dGVybmFsc3RvcmFnZS5kb2N1bWVudHNcIiA9PT0gdXJpLmdldEF1dGhvcml0eSgpO1xuICAgIH1cblxuICAgIGlzRG93bmxvYWRzRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLnByb3ZpZGVycy5kb3dubG9hZHMuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBpc01lZGlhRG9jdW1lbnQodXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLnByb3ZpZGVycy5tZWRpYS5kb2N1bWVudHNcIiA9PT0gdXJpLmdldEF1dGhvcml0eSgpO1xuICAgIH1cblxuICAgIGdldENvbnRlbnRSZXNvbHZlcigpIHtcbiAgICAgICAgcmV0dXJuIGFwcGxpY2F0aW9uLmFuZHJvaWQubmF0aXZlQXBwLmdldENvbnRlbnRSZXNvbHZlcigpO1xuICAgIH1cbn0iXX0=